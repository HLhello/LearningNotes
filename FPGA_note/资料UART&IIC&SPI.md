# UART & IIC & SPI

背景

- 现今，在低端数字通信应用领域，我们随处可见IIC (Inter-Integrated Circuit) 和 SPI (Serial Peripheral Interface)的身影。原因是这两种通信协议非常适合近距离低速芯片间通信。Philips（for IIC）和Motorola（for SPI） 出于不同背景和市场需求制定了这两种标准通信协议。

我们来看看比特速递公司(bit-delivering company,PDC)是如何输送8bit货物的。

现在有一辆拉载着8bit数据的快递货车由公司(PC端/嵌入式端/外设设备)发出。携带着齐全证件(起始位、奇偶位、停止位)，愉快地上路了。

仪表盘上显示着稳定地9600bps，表示一秒可送9600bit(包括证件在内)，经过“长途跋涉”，终于到达终点站(另一个PC/嵌入式/外设设备)。

首先，货车司机出示货运单(起始位)表示“您要的货到了”，这时，终点站验货员要对其进行验货。可悲的是，验货员是个瞎子，他可不能一个一个地数。幸好，早在发货之前双方已经约定，使用中华传统技艺——接头暗号(奇偶位)——进行验货。他们的规则是：发货公司表示，今天的暗号是天王盖地虎(奇校检)，那么货运单上写的就是宝塔镇河妖(哎对上了);而公司要是说，今天的暗号是今朝有酒今朝醉(偶校检)，货运单上还是宝塔镇河妖，那就对不上。因为tomorrow is an other day才是正解。

瞎子验货员一看货运单，哎一拍即合，验货员笑纳了8bit的数据。可别急，还得检查是否漏货，万一少了一两个bit，那就乱码了。一看货运单上的标示(停止位)，瞎子哥终于放心地签收了，然后摆摆手，这时货车靠边(空闲位)腾出空位。瞎子哥等待下一辆货车。

发现没
​       第一：所有证件(起始位，停止位，奇偶位)都由比特速递公司(即发送端)提供。
​       第二：货物(8bit数据)只能一车一车有序接收或者从公司发送。
第三：空闲位需要瞎子验货员摆手示意。也就是说，空闲位不属于速递公司的必备证件，终点站在收货后，自己腾出空位来，等待下一辆货车。


实际上，在硬件逻辑电路中实现发送端给的货车装货、配备证件和运货单需要严格按照图1的格式，数据流(包括起始位、停止位和校检位)必须按照按照波特率规定的速度一bit一bit地输送出去。而接受端，需要严格按照波特率规定的速度，在每一个bit的中间位置处采集送来的信号(为了数据的顺利采集，有时将每一个bit分成数份，再在每小份的中间位置采集)。



​    常见比特率——9600bps 19200bps 38400bps 57600bps 115200bps



UART协议格式

信号线上空闲的时候为高电平，当出现下跳到低电平的时候表示数据的起始位，接着是先发送低位（LSB）后发送高位（MSB）的数据流，尾部可加奇偶校验位，最后加停止位，停止位长度可以定义。本例实现无奇偶校验位，1bit停止位，波特率9600~115200可改变。



![img](https://pic2.zhimg.com/v2-e346b48a1e446d1f17c87daf844d4959_b.jpg)



多帧发送结构如下：



![img](https://pic2.zhimg.com/v2-df58049d703fc5171014412118dc6241_b.jpg)



代码实现解释





## 名词解释

SPI --SPI是串行外设接口（Serial Peripheral Interface） 

SDIO --（Secure Digital Input and Output）安全数字输入输出卡定义了一种外设接口 

UART --通用异步收发传输器（Universal Asynchronous Receiver/Transmitter)，通常称作UART。 

USB --USB，是英文Universal Serial Bus（通用串行总线）的缩写，是一个外部总线标准，用于规范电脑与外部 设备的连接和通讯。 

IIC --I²C（Inter-Integrated Circuit）字面上的意思是集成电路之间，它其实是I²C Bus简称，所以中文应该叫集成电 路总线，它是一种串行通信总线，使用多主从架构。 

PWM --脉冲宽度调制（Pulse width modulation，PWM）技术。 

IIS --IIS 总线IIS(Integrate Interface of Sound)即集成音频接口。 

GPIO --GPIO（英语：General-purpose input/output），通用型之输入输出的简称。

RS232：逻辑“1”为-3到-15V;逻辑“0”为+3到+15V只需要三条接口线，即“发送数据TXD”、“接收数据 RXD”和“信号地GND”。

RS485:逻辑“1”以两线间的电压差为-(2~6)V表示;逻辑“0”以两线间的电压差为+(2~6)V表示。

TTL接口+5V等价于逻辑“1”，0V等价于逻辑“0”，这被称做TTL(晶体管-晶体管逻辑电平TransistorTransistor Logic)。

RS232 RS485是数据的传输方式；232是直接高低电平的传输方式；485是使用差分的传输方式，2种传输方式的不 同体现在电平的标准上。



## IIC接口

IIC串行总线我认为还是比较简单的，在今天的一个面试中，让我介绍了IIC，最后问我问题时，IIC是在什么时候把数据打入从机？

我当时的回答是：上升沿？这是错误的。是在高电平时期。

为了更加深入了解IIC，因此我又学习了一下。

总线信号 ： SDA ：串行数据线　SCL  ：串行时钟

总线空闲状态 ：SDA ：高电平　SCL ：高电平

起始位：SCL为高电平期间    SDA出现下降沿

![起始信号](E:\LearningNotes\FPGA_note\IIC起始信号.jpg)

起始信号

终止位：SCL为高电平期间 SDA出现上升沿

![终止信号](E:\LearningNotes\FPGA_note\IIC终止信号.jpg)

终止信号

数据传输 ：SDA的数据在SCL高电平期间被写入从机。所以SDA的数据变化要发生在SCL低电平期间。

![数据传输时期](E:\LearningNotes\FPGA_note\IIC数据传输时期.jpg)

数据传输时期

IIC时钟频率：不高于400K

应答：当IIC主机（不一定是发送端还是接受端）将8位数据或命令传出后，会将SDA信号设置为输入，等待从机应答（等待SDA由高电平拉为低电平）。若从机正确应答，表明数据或者命令传输成功，否则传输失败，注意，应答信号是数据接收方发送给数据发送方的。

IIC器件地址：每一个IIC器件都有一个器件地址，有的器件地址在出厂时地址就设定好了，用户不可以更改,比如OV7670的地址为0x42。有的器件例如EEPROM，前四个地址已经确定为1010，后三个地址是由硬件链接确定的，所以一个IIC总线最多能连8个EEPROM芯片。

![例子](E:\LearningNotes\FPGA_note\IIC单字节写时序.jpg)

例子

图上开始信号之后，七位地址代表器件地址，第八位代表读或者写，0为写，1代表读，然后跟着响应位。

IIC器件单字节写时序：

![单字节写时序](E:\LearningNotes\FPGA_note\IIC单字节器件写时序.jpg)

单字节写时序

IIC器件多字节地址写时序：多字节地址比单字节地址在时序上就多了一块写地址

![多字节地址写时序](E:\LearningNotes\FPGA_note\IIC多字节地址写时序.jpg)

多字节地址写时序

单字节器件读时序：注意最后产生无应答信号，另外多字节地址读时序跟单字节类似，只不过是多了几个地址字节而已。

![单字节器件读时序](E:\LearningNotes\FPGA_note\IIC单字节器件读时序.jpg)

单字节器件读时序

三大串行总线：uart、spi、iic

同步：spi　　异步：iic，uart

同步和异步区别：采集数据是否用的是时钟的沿，如果是时钟沿采数据，同步传输，如果电平采集数据是异步。串口接受数据其实就是一个串转并的过程。



## IIC接口与spi接口比较

作者：树懒说物联

链接：https://zhuanlan.zhihu.com/p/63879154

来源：知乎

著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

**IIC vs SPI**
现今，在低端数字通信应用领域，我们随处可见IIC (Inter-Integrated Circuit) 和 SPI (Serial Peripheral Interface)的身影。原因是这两种通信协议非常适合近距离低速芯片间通信。Philips（for IIC）和Motorola（for SPI） 出于不同背景和市场需求制定了这两种标准通信协议。

IIC 开发于1982年，当时是为了给电视机内的CPU和外围芯片提供更简易的互联方式。电视机是最早的嵌入式系统之一，而最初的嵌入系统是使用内存映射（memory-mapped I/O）的方式来互联微控制器和外围设备的。要实现内存映射，设备必须并联入微控制器的数据线和地址线，这种方式在连接多个外设时需大量线路和额外地址解码芯片，很不方便并且成本高。

为了节省微控制器的引脚和和额外的逻辑芯片，使印刷电路板更简单，成本更低，位于荷兰的Philips实验室开发了 ‘Inter-Integrated Circuit’，IIC 或 IIC ，一种只使用二根线接连所有外围芯片的总线协议。最初的标准定义总线速度为100kbps。经历几次修订，主要是1995年的400kbps，1998的3.4Mbps。

SPI总线首次推出是在1979年，Motorola公司将SPI总线集成在他们第一支改自68000微处理器的微控制器芯片上。SPI总线是微控制器四线的外部总线（相对于内部总线）。与IIC不同，SPI没有明文标准，只是一种事实标准，对通信操作的实现只作一般的抽象描述，芯片厂商与驱动开发者通过data sheets和application notes沟通实现上的细节。

**SPI**





对于有经验的数字电子工程师来说，用SPI互联两支数字设备是相当直观的。SPI是种四根信号线协议（如图）：





![img](E:\LearningNotes\FPGA_note\spi接口示意图.jpg)





- SCLK: Serial Clock (output from master);
- MOSI; SIMO: Master Output, Slave Input(output from master);
- MISO; SOMI: Master Input, Slave Output(output from slave);
- SS: Slave Select (active low, outputfrom master).

SPI是［单主设备（ single-master ）］通信协议，这意味着总线中的只有一支中心设备能发起通信。当SPI主设备想读/写［从设备］时，它首先拉低［从设备］对应的SS线（SS是低电平有效），接着开始发送工作脉冲到时钟线上，在相应的脉冲时间上，［主设备］把信号发到MOSI实现“写”，同时可对MISO采样而实现“读”，如下图：



![img](E:\LearningNotes\FPGA_note\spi时序图.jpg)



SPI有四种操作模式——模式0、模式1、模式2和模式3，它们的区别是定义了在时钟脉冲的哪条边沿转换（toggles）输出信号，哪条边沿采样输入信号，还有时钟脉冲的稳定电平值（就是时钟信号无效时是高还是低）。每种模式由一对参数刻画，它们称为时钟极（clock polarity）CPOL与时钟期（clock phase）CPHA。





![img](E:\LearningNotes\FPGA_note\spi工作模式.jpg)



［主从设备］必须使用相同的工作参数——SCLK、CPOL 和 CPHA，才能正常工作。如果有多个［从设备］，并且它们使用了不同的工作参数，那么［主设备］必须在读写不同［从设备］间重新配置这些参数。以上SPI总线协议的主要内容。SPI不规定最大传输速率，没有地址方案；SPI也没规定通信应答机制，没有规定流控制规则。事实上，SPI［主设备］甚至并不知道指定的［从设备］是否存在。这些通信控制都得通过SPI协议以外自行实现。例如，要用SPI连接一支［命令-响应控制型］解码芯片，则必须在SPI的基础上实现更高级的通信协议。SPI并不关心物理接口的电气特性，例如信号的标准电压。在最初，大多数SPI应用都是使用间断性时钟脉冲和以字节为单位传输数据的，但现在有很多变种实现了连续性时间脉冲和任意长度的数据帧。

**IIC**

与SPI的单主设备不同，IIC 是多主设备的总线，IIC没有物理的芯片选择信号线，没有仲裁逻辑电路，只使用两条信号线—— ‘serial data’ (SDA) 和 ‘serial clock’ (SCL)。IIC协议规定：

- 第一，每一支IIC设备都有一个唯一的七位设备地址；
- 第二，数据帧大小为8位的字节；
- 第三，数据（帧）中的某些数据位用于控制通信的开始、停止、方向（读写）和应答机制。

IIC 数据传输速率有标准模式（100 kbps）、快速模式（400 kbps）和高速模式（3.4 Mbps），另外一些变种实现了低速模式（10 kbps）和快速+模式（1 Mbps）。

物理实现上，IIC 总线由两根信号线和一根地线组成。两根信号线都是双向传输的，参考下图。IIC协议标准规定发起通信的设备称为主设备，主设备发起一次通信后，其它设备均为从设备。



![img](E:\LearningNotes\FPGA_note\IIC电路示意图.jpg)



IIC 通信过程大概如下。首先，主设备发一个START信号，这个信号就像对所有其它设备喊：请大家注意！然后其它设备开始监听总线以准备接收数据。接着，主设备发送一个7位设备地址加一位的读写操作的数据帧。当所设备接收数据后，比对地址自己是否目标设备。如果比对不符，设备进入等待状态，等待STOP信号的来临；如果比对相符，设备会发送一个应答信号——ACKNOWLEDGE作回应。

当主设备收到应答后便开始传送或接收数据。数据帧大小为8位，尾随一位的应答信号。主设备发送数据，从设备应答；相反主设备接数据，主设备应答。当数据传送完毕，主设备发送一个STOP信号，向其它设备宣告释放总线，其它设备回到初始状态。



![img](E:\LearningNotes\FPGA_note\IIC数据位划分.jpg)



基于IIC总线的物理结构，总线上的START和STOP信号必定是唯一的。另外，IIC总线标准规定SDA线的数据转换必须在SCL线的低电平期，在SCL线的高电平期，SDA线的上数据是稳定的。



![img](E:\LearningNotes\FPGA_note\IIC时序图.jpg)



在物理实现上，SCL线和SDA线都是漏极开路（open-drain），通过上拉电阻外加一个电压源。当把线路接地时，线路为逻辑0，当释放线路，线路空闲时，线路为逻辑1。基于这些特性，IIC设备对总线的操作仅有“把线路接地”——输出逻辑0。

IIC总线设计只使用了两条线，但相当优雅地实现任意数目设备间无缝通信，堪称完美。我们设想一下，如果有两支设备同时向SCL线和SDA线发送信息会出现什么情况。

基于IIC总线的设计，线路上不可能出现电平冲突现象。如果一支设备发送逻辑0，其它发送逻辑1，那么线路看到的只有逻辑0。也就是说，如果出现电平冲突，发送逻辑0的始终是“赢家”。

总线的物理结构亦允许主设备在往总线写数据的同时读取数据。这样，任何设备都可以检测冲突的发生。当两支主设备竞争总线的时候，“赢家”并不知道竞争的发生，只有“输家”发现了冲突——当它写一个逻辑1，却读到0时——而退出竞争。

**10位设备地址**

任何IIC设备都有一个7位地址，理论上，现实中只能有127种不同的IIC设备。实际上，已有IIC的设备种类远远多于这个限制，在一条总线上出现相同的地址的IIC设备的概率相当高。为了突破这个限制，很多设备使用了双重地址——7位地址加引脚地址（external configuration pins）。IIC 标准也预知了这种限制，提出10位的地址方案。

**10位的地址方案对 IIC协议的影响有两点：**

- 第一，地址帧为两个字节长，原来的是一个字节；
- 第二，第一个字节前五位最高有效位用作10位地址标识，约定是“11110”。





![img](E:\LearningNotes\FPGA_note\IIC地址帧.jpg)



除了10位地址标识，标准还预留了一些地址码用作其它用途，如下表：



![img](E:\LearningNotes\FPGA_note\IIC扩展地址帧的其他作用.jpg)



**时钟拉伸**
在 IIC 通信中，主设备决定了时钟速度。因为时钟脉冲信号是由主设备显式发出的。但是，当从设备没办法跟上主设备的速度时，从设备需要一种机制来请求主设备慢一点。这种机制称为时钟拉伸，而基于I²C结构的特殊性，这种机制得到实现。当从设备需要降低传输的速度的时候，它可以按下时钟线，逼迫主设备进入等待状态，直到从设备释放时钟线，通信才继续。



**高速模式**
原理上讲，使用上拉电阻来设置逻辑1会限制总线的最大传输速度。而速度是限制总线应用的因素之一。这也说明为什么要引入高速模式（3.4 Mbps）。在发起一次高速模式传输前，主设备必须先在低速的模式下（例如快速模式）发出特定的“High Speed Master”信号。为缩短信号的周期和提高总线速度，高速模式必须使用额外的I/O缓冲区。另外，总线仲裁在高速模式下可屏蔽掉。更多的信息请参与总线标准文档。



**IIC vs SPI: 哪位是赢家？**

**我们来对比一下IIC 和 SPI的一些关键点：**
**第一，总线拓扑结构/信号路由/硬件资源耗费**
IIC 只需两根信号线，而标准SPI至少四根信号，如果有多个从设备，信号需要更多。一些SPI变种虽然只使用三根线——SCLK, SS和双向的MISO/MOSI，但SS线还是要和从设备一对一根。另外，如果SPI要实现多主设备结构，总线系统需额外的逻辑和线路。用IIC 构建系统总线唯一的问题是有限的7位地址空间，但这个问题新标准已经解决——使用10位地址。从第一点上看，IIC是明显的大赢家。

**第二，数据吞吐/传输速度**
如果应用中必须使用高速数据传输，那么SPI是必然的选择。因为SPI是全双工，IIC 的不是。SPI没有定义速度限制，一般的实现通常能达到甚至超过10 Mbps。IIC 最高的速度也就快速+模式（1 Mbps）和高速模式（3.4 Mbps），后面的模式还需要额外的I/O缓冲区，还并不是总是容易实现的。

**第三，优雅性**
IIC 常被称更优雅于SPI。公正的说，我们更倾向于认为两者同等优雅和健壮。IIC的优雅在于它的特色——用很轻盈的架构实现了多主设备仲裁和设备路由。但是对使用的工程师来讲，理解总线结构更费劲，而且总线的性能不高。

SPI的优点在于它的结构相当的直观简单，容易实现，并且有很好扩展性。SPI的简单性不足称其优雅，因为要用SPI搭建一个有用的通信平台，还需要在SPI之上构建特定的通信协议软件。也就是说要想获得SPI特有而IIC没有的特性——高速性能，工程师们需要付出更多的劳动。另外，这种自定的工作是完全自由的，这也说明为什么SPI没有官方标准。IIC和SPI都对低速设备通信提供了很好的支持，不过，SPI适合数据流应用，而IIC更适合“字节设备”的多主设备应用。

**小结**
在数字通信协议簇中，IIC和SPI常称为“小”协议，相对Ethernet, USB, SATA, PCI-Express等传输速度达数百上千兆字节每秒的总线。但是，我们不能忘记的是各种总线的用途是什么。“大”协议是用于系统外的整个系统之间通信的，“小”协议是用于系统内各芯片间的通信，没有迹象表明“大”协议有必要取代“小”协议。IIC和SPI的存在和流行体现了“够用就好”的哲学。回应文首，IIC和SPI如此的流行，它是任何一位嵌入式工程师必备的工具。





## 常见协议的缩写与全称

通用异步收发传协议（UART）

集成电路总线协议（IIC）（I方c）

串行外围总线协议（SPI）

通用串行总线协议（USB 2.0/3.0）

以太网协议（Ethernet）